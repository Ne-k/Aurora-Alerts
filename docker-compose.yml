services:
  noaa_alert:
    build: .
    volumes:
      - .:/app
    entrypoint: ["bash", "-c"]
    environment:
      - DISCORD_WEBHOOK=${DISCORD_WEBHOOK}
      - KP_THRESHOLD=${KP_THRESHOLD:-6.5}
    command: >
      echo '0 8 * * * cd /app && python -u "noaa alert.py" >> /var/log/cron.log 2>&1' > /etc/cron.d/noaa_alert &&
      chmod 0644 /etc/cron.d/noaa_alert &&
      crontab /etc/cron.d/noaa_alert &&
      touch /var/log/cron.log &&
      echo "[UTC $(date -u +'%F %T')] Container started. Cron scheduled for 08:00 UTC daily." >> /var/log/cron.log &&
      echo "[UTC $(date -u +'%F %T')] Running once on startup..." >> /var/log/cron.log &&
      cd /app && python -u "noaa alert.py" >> /var/log/cron.log 2>&1 || true &&
      cron && tail -F /var/log/cron.log
    restart: always
  